<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Health Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
const { useState, useEffect, useCallback } = React;

// --- ICONS (as inline SVG components for simplicity) ---
const DumbbellIcon = ({ className }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <rect x="2" y="9" width="4" height="6" rx="1"></rect>
    <rect x="18" y="9" width="4" height="6" rx="1"></rect>
  </svg>
);
const FlameIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
);
const BrainIcon = ({ className }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.98-1.58 2.5 2.5 0 0 1-2.01-2.32V15a2.5 2.5 0 0 1 2.5-2.5h1.1A2.5 2.5 0 0 0 8 10V4.5A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.98-1.58 2.5 2.5 0 0 0 2.01-2.32V15a2.5 2.5 0 0 0-2.5-2.5h-1.1A2.5 2.5 0 0 1 16 10V4.5A2.5 2.5 0 0 0 14.5 2Z"/></svg>
);
const HomeIcon = ({ className }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
);
const TargetIcon = ({ className }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
);
const SettingsIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
);
const CheckCircleIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
);
const CircleIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/></svg>
);
const PlusIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
);
const MinusIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
);
const PlayIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
);
const PauseIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
);
const SparklesIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.5 3L7 7.5l3 1.5L12 12l1.5-3L17 7.5l-3-1.5z"/><path d="M5 11.5 3 10l-2 1.5 1.5 2-1.5 2 2 1.5 2-1.5-1.5-2z"/><path d="M19 11.5 17 10l-2 1.5 1.5 2-1.5 2 2 1.5 2-1.5-1.5-2z"/><path d="m12 21-1.5-3L7 16.5l3-1.5L12 12l1.5 3L17 16.5l-3 1.5z"/></svg>
);
const XIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
);


// --- DATA & CONFIGURATION (DEFAULTS) ---
const DEFAULT_USER_PROFILE = {
    name: "User",
    currentWeight: 98,
    targetWeight: 80,
    height: 178,
    age: 58,
};

const DEFAULT_NUTRITION_TARGETS = {
    calories: 2100,
    protein: 145,
};

const DEFAULT_MEAL_PLAN = {
    breakfast: { name: "Tofu Scramble", calories: 450, protein: 35 },
    lunch: { name: "Lentil & Quinoa Bowl", calories: 600, protein: 30 },
    snack: { name: "Protein Shake", calories: 400, protein: 45 },
    dinner: { name: "Seitan Stir-fry", calories: 600, protein: 35 },
};

const WORKOUT_PLAN = [
    { day: "Sunday", type: "Active Recovery", details: { name: "Active Recovery", exercises: [{ name: "Gentle walk or stretching", reps: "20-30 minutes" }] } },
    { day: "Monday", type: "Upper Body A (Push)", details: { name: "Upper Body A (Push)", exercises: [{ name: "Dumbbell Bench Press", sets: 3, reps: "10-12" }, { name: "Seated Dumbbell Overhead Press", sets: 3, reps: "10-12" }, { name: "Incline Push-ups", sets: 3, reps: "To near failure" }, { name: "Dumbbell Overhead Triceps Extension", sets: 3, reps: "12-15" }] } },
    { day: "Tuesday", type: "Lower Body & Core", details: { name: "Lower Body & Core", exercises: [{ name: "Glute Bridges", sets: 3, reps: "15-20" }, { name: "Box Squats (to high chair)", sets: 3, reps: "10-12" }, { name: "Dumbbell Romanian Deadlifts (RDLs)", sets: 3, reps: "12-15" }, { name: "Plank", sets: 3, reps: "30-60 sec hold" }] } },
    { day: "Wednesday", type: "Cardio & Core", details: { name: "Cardio & Core", exercises: [{ name: "Rowing Machine Intervals", reps: "20 mins total (see details)" }, { name: "Lying Leg Raises", sets: 3, reps: "15-20" }, { name: "Bird-Dog", sets: 3, reps: "10 per side" }] } },
    { day: "Thursday", type: "Upper Body B (Pull)", details: { name: "Upper Body B (Pull)", exercises: [{ name: "Bent-Over Dumbbell Rows", sets: 3, reps: "10-12" }, { name: "Single-Arm Dumbbell Row", sets: 3, reps: "10-12 per arm" }, { name: "Dumbbell Bicep Curls", sets: 3, reps: "12-15 per arm" }, { name: "Dumbbell Shrugs", sets: 3, reps: "15" }] } },
    { day: "Friday", type: "Lower Body & Core", details: { name: "Lower Body & Core", exercises: [{ name: "Glute Bridges", sets: 3, reps: "15-20" }, { name: "Box Squats (to high chair)", sets: 3, reps: "10-12" }, { name: "Dumbbell Romanian Deadlifts (RDLs)", sets: 3, reps: "12-15" }, { name: "Plank", sets: 3, reps: "30-60 sec hold" }] } },
    { day: "Saturday", type: "Cardio & Core", details: { name: "Cardio & Core", exercises: [{ name: "Rowing Machine Intervals", reps: "20 mins total (see details)" }, { name: "Lying Leg Raises", sets: 3, reps: "15-20" }, { name: "Bird-Dog", sets: 3, reps: "10 per side" }] } },
];


// --- HELPER HOOK for Local Storage ---
function useStickyState(defaultValue, key) {
    const [value, setValue] = useState(() => {
        const stickyValue = window.localStorage.getItem(key);
        return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
    });
    useEffect(() => {
        window.localStorage.setItem(key, JSON.stringify(value));
    }, [key, value]);
    return [value, setValue];
}


// --- UI Components ---

const Card = ({ children, className = '' }) => (
    <div className={`bg-gray-800 rounded-2xl p-4 md:p-6 shadow-lg ${className}`}>
        {children}
    </div>
);

const CircularProgress = ({ percentage, label, icon: Icon, color }) => {
    const radius = 50;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (percentage / 100) * circumference;

    return (
        <div className="flex flex-col items-center justify-center text-center">
            <div className="relative w-24 h-24 md:w-32 md:h-32">
                <svg className="w-full h-full" viewBox="0 0 120 120">
                    <circle className="text-gray-700" strokeWidth="10" stroke="currentColor" fill="transparent" r={radius} cx="60" cy="60" />
                    <circle
                        className={color}
                        strokeWidth="10"
                        strokeDasharray={circumference}
                        strokeDashoffset={offset}
                        strokeLinecap="round"
                        stroke="currentColor"
                        fill="transparent"
                        r={radius}
                        cx="60"
                        cy="60"
                        transform="rotate(-90 60 60)"
                        style={{ transition: 'stroke-dashoffset 0.5s ease-out' }}
                    />
                </svg>
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                    {Icon && <Icon className="w-6 h-6 md:w-8 md:h-8 text-gray-400 mb-1" />}
                    <span className="text-lg md:text-xl font-bold text-white">{`${percentage.toFixed(0)}%`}</span>
                </div>
            </div>
            <p className="mt-2 text-xs md:text-sm text-gray-300 font-medium">{label}</p>
        </div>
    );
};


// --- View Components ---

const Dashboard = ({ profile, nutritionTargets, todayLog, onNavigate }) => {
    const weightLossTotal = profile.initialWeight ? profile.initialWeight - profile.targetWeight : profile.currentWeight - profile.targetWeight;
    const weightLossSoFar = profile.initialWeight ? profile.initialWeight - profile.currentWeight : 0;
    const weightProgress = weightLossTotal > 0 ? (weightLossSoFar / weightLossTotal) * 100 : 0;
    
    const today = new Date().toLocaleString('en-us', { weekday: 'long' });
    const todayPlan = WORKOUT_PLAN.find(p => p.day === today);

    const workoutProgress = todayLog.workoutCompleted ? 100 : 0;
    const caloriesProgress = todayLog.calories > 0 && nutritionTargets.calories > 0 ? (todayLog.calories / nutritionTargets.calories) * 100 : 0;
    const calmProgress = todayLog.calmCompleted ? 100 : 0;


    return (
        <div className="space-y-6">
            <Card>
                <h1 className="text-2xl md:text-3xl font-bold text-white">Welcome back, {profile.name}</h1>
                <p className="text-gray-400">Here's your progress for today.</p>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Weight Goal</h2>
                <div className="flex items-center space-x-4">
                    <TargetIcon className="w-8 h-8 text-cyan-400" />
                    <div className="w-full">
                        <div className="flex justify-between text-sm font-medium text-gray-300 mb-1">
                            <span>{profile.currentWeight} kg</span>
                            <span>{profile.targetWeight} kg</span>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5">
                            <div className="bg-cyan-500 h-2.5 rounded-full" style={{ width: `${Math.min(weightProgress, 100)}%` }}></div>
                        </div>
                    </div>
                </div>
            </Card>

            <Card>
                 <h2 className="text-lg font-semibold text-white mb-4">Daily Goals</h2>
                <div className="grid grid-cols-3 gap-2 md:gap-4">
                    <CircularProgress percentage={workoutProgress} label="Workout" icon={DumbbellIcon} color="text-pink-500" />
                    <CircularProgress percentage={caloriesProgress} label="Calories" icon={FlameIcon} color="text-orange-500" />
                    <CircularProgress percentage={calmProgress} label="Calm" icon={BrainIcon} color="text-teal-400" />
                </div>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Today's Plan: <span className="text-cyan-400">{todayPlan.type}</span></h2>
                <div className="space-y-3">
                    <button onClick={() => onNavigate('workout')} className="w-full flex items-center space-x-3 bg-gray-700 hover:bg-gray-600 p-4 rounded-lg transition-colors">
                        <DumbbellIcon className="w-6 h-6 text-pink-500" />
                        <span className="text-white font-medium">View Workout</span>
                    </button>
                     <button onClick={() => onNavigate('nutrition')} className="w-full flex items-center space-x-3 bg-gray-700 hover:bg-gray-600 p-4 rounded-lg transition-colors">
                        <FlameIcon className="w-6 h-6 text-orange-500" />
                        <span className="text-white font-medium">Track Nutrition</span>
                    </button>
                     <button onClick={() => onNavigate('calm')} className="w-full flex items-center space-x-3 bg-gray-700 hover:bg-gray-600 p-4 rounded-lg transition-colors">
                        <BrainIcon className="w-6 h-6 text-teal-400" />
                        <span className="text-white font-medium">Start Calm Session</span>
                    </button>
                </div>
            </Card>
        </div>
    );
};

const WorkoutScreen = ({ plan, onCompleteWorkout, workoutCompleted, apiKey }) => {
    const [completedSets, setCompletedSets] = useState({});
    const [finisher, setFinisher] = useState(null);
    const [isLoadingFinisher, setIsLoadingFinisher] = useState(false);
    const [error, setError] = useState('');

    const toggleSet = (exerciseIndex, setIndex) => {
        const key = `${exerciseIndex}-${setIndex}`;
        setCompletedSets(prev => ({...prev, [key]: !prev[key]}));
    };
    
    const allSetsCompleted = plan.details.exercises.every((ex, exIndex) => 
        !ex.sets || Array.from({ length: ex.sets }).every((_, setIndex) => completedSets[`${exIndex}-${setIndex}`])
    );
    
    const fetchWorkoutFinisher = async () => {
        setIsLoadingFinisher(true);
        setError('');
        setFinisher(null);

        const prompt = `You are an expert personal trainer specializing in low-impact, knee-friendly exercises for individuals over 50. I just completed a "${plan.type}" workout. Generate one single "finisher" exercise to end the workout. The exercise must be low-impact, safe for bad knees, and use only bodyweight or dumbbells. Provide the exercise name, a brief description of how to perform it, and the recommended sets and reps (e.g., 2 sets of 15 reps, or 1 set for 60 seconds).`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                setFinisher(text);
            } else {
                throw new Error("No content received from API.");
            }
        } catch (err) {
            console.error(err);
            setError('Failed to generate finisher. Please try again.');
        } finally {
            setIsLoadingFinisher(false);
        }
    };


    return (
        <div className="space-y-6">
            <Card>
                <h1 className="text-2xl font-bold text-white">{plan.details.name}</h1>
                <p className="text-gray-400">{plan.day}</p>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Warm-up (5 mins)</h2>
                <ul className="list-disc list-inside text-gray-300 space-y-1">
                    <li>2-3 minutes of light rowing</li>
                    <li>Arm Circles, Torso Twists, Cat-Cow</li>
                </ul>
            </Card>
            
            <div className="space-y-4">
                {plan.details.exercises.map((exercise, exIndex) => (
                    <Card key={exIndex}>
                        <h3 className="font-semibold text-white text-lg">{exercise.name}</h3>
                        <p className="text-cyan-400 mb-3">{exercise.sets ? `${exercise.sets} sets of` : ''} {exercise.reps} reps</p>
                        {exercise.sets && (
                            <div className="flex flex-wrap gap-3">
                                {Array.from({ length: exercise.sets }).map((_, setIndex) => (
                                    <button
                                        key={setIndex}
                                        onClick={() => toggleSet(exIndex, setIndex)}
                                        className={`w-16 h-10 rounded-lg flex items-center justify-center font-bold text-sm transition-all ${completedSets[`${exIndex}-${setIndex}`] ? 'bg-pink-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                    >
                                        SET {setIndex + 1}
                                    </button>
                                ))}
                            </div>
                        )}
                        {exercise.name.includes("Rowing") && (
                             <div className="mt-4 text-sm text-gray-300 bg-gray-900/50 p-3 rounded-lg">
                                <p className="font-bold mb-1">Rowing Interval Guide:</p>
                                <p>• 5 mins steady warm-up.</p>
                                <p>• 8 rounds: 1 min hard, 1 min easy.</p>
                                <p>• 4 mins steady cool-down.</p>
                                <p className="mt-2 text-xs text-gray-500">Always maintain good form: back straight, powerful leg drive.</p>
                             </div>
                        )}
                    </Card>
                ))}
            </div>

            {(allSetsCompleted || workoutCompleted) && (
                <Card>
                    <h2 className="text-lg font-semibold text-white mb-4">Workout Finisher</h2>
                    {finisher && !isLoadingFinisher && (
                        <div className="text-gray-300 whitespace-pre-wrap bg-gray-900/50 p-3 rounded-lg">{finisher}</div>
                    )}
                    {isLoadingFinisher && <p className="text-center text-gray-400">✨ Generating finisher...</p>}
                    {!finisher && !isLoadingFinisher && (
                        <button onClick={fetchWorkoutFinisher} className="w-full p-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold flex items-center justify-center gap-2 transition-colors">
                            <SparklesIcon className="w-5 h-5" /> Generate Finisher
                        </button>
                    )}
                    {error && <p className="text-red-400 text-sm text-center mt-2">{error}</p>}
                </Card>
            )}

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Cool-down (5 mins)</h2>
                <ul className="list-disc list-inside text-gray-300 space-y-1">
                    <li>Hold each stretch for 20-30 seconds</li>
                    <li>Chest, Hamstring, Quad, Upper Back stretches</li>
                </ul>
            </Card>

             <button 
                onClick={onCompleteWorkout}
                disabled={(!allSetsCompleted && plan.type !== 'Active Recovery') || workoutCompleted}
                className={`w-full p-4 rounded-lg font-bold text-white transition-all flex items-center justify-center gap-2 ${
                    workoutCompleted 
                    ? 'bg-green-500 cursor-not-allowed' 
                    : allSetsCompleted || plan.type === 'Active Recovery'
                    ? 'bg-pink-600 hover:bg-pink-700' 
                    : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                }`}
            >
                {workoutCompleted ? <><CheckCircleIcon className="w-6 h-6" /> Workout Logged!</> : 'Complete Workout'}
            </button>
        </div>
    );
};

const NutritionScreen = ({ todayLog, setTodayLog, nutritionTargets, mealPlan, apiKey }) => {
    const { calories, protein, meals, water } = todayLog;
    const [suggestions, setSuggestions] = useState([]);
    const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);
    const [error, setError] = useState('');
    const [showSuggestionsModal, setShowSuggestionsModal] = useState(false);
    const [suggestionMealType, setSuggestionMealType] = useState('');

    const toggleMeal = (mealKey) => {
        const meal = mealPlan[mealKey];
        if(!meal) return;
        const isLogged = meals[mealKey];
        
        setTodayLog(prev => ({
            ...prev,
            calories: isLogged ? prev.calories - meal.calories : prev.calories + meal.calories,
            protein: isLogged ? prev.protein - meal.protein : prev.protein + meal.protein,
            meals: {
                ...prev.meals,
                [mealKey]: !isLogged
            }
        }));
    };
    
    const handleWater = (amount) => {
        setTodayLog(prev => ({...prev, water: Math.max(0, prev.water + amount)}));
    };

    const fetchMealSuggestions = async (mealType) => {
        setSuggestionMealType(mealType);
        setIsLoadingSuggestions(true);
        setError('');
        setSuggestions([]);
        setShowSuggestionsModal(true);

        const mealTargets = mealPlan[mealType];
        if (!mealTargets) {
            setError('Meal details not found.');
            setIsLoadingSuggestions(false);
            return;
        }
        
        const prompt = `Act as an expert vegan nutritionist. Suggest 3 alternative high-protein vegan meal ideas for ${mealType}. Each meal should be around ${mealTargets.calories} calories and ${mealTargets.protein}g of protein. The user has bad knees, so suggest meals that are easy to prepare without much standing.`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            mealName: { type: "STRING" },
                            description: { type: "STRING" },
                            calories: { type: "NUMBER" },
                            protein: { type: "NUMBER" }
                        },
                        required: ["mealName", "description", "calories", "protein"]
                    }
                }
            }
        };

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) {
                const parsedJson = JSON.parse(jsonText);
                setSuggestions(parsedJson);
            } else {
                throw new Error("No content received from API.");
            }
        } catch (err) {
            console.error(err);
            setError('Failed to get suggestions. Please check your API key or try again.');
        } finally {
            setIsLoadingSuggestions(false);
        }
    };
    
    return (
        <div className="space-y-6">
            <Card>
                <h1 className="text-2xl font-bold text-white">Nutrition Tracker</h1>
                <p className="text-gray-400">Log your meals and hydration for the day.</p>
            </Card>
            
            <Card>
                <div className="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p className="text-sm text-gray-400">Calories</p>
                        <p className="text-2xl font-bold text-white">{calories.toFixed(0)} / <span className="text-lg text-orange-400">{nutritionTargets.calories}</span></p>
                    </div>
                     <div>
                        <p className="text-sm text-gray-400">Protein</p>
                        <p className="text-2xl font-bold text-white">{protein.toFixed(0)}g / <span className="text-lg text-orange-400">{nutritionTargets.protein}g</span></p>
                    </div>
                </div>
                <div className="mt-4 bg-gray-700 rounded-full h-2.5">
                    <div className="bg-orange-500 h-2.5 rounded-full" style={{ width: `${Math.min((calories / nutritionTargets.calories) * 100, 100)}%` }}></div>
                </div>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Daily Meal Plan</h2>
                <div className="space-y-3">
                {Object.entries(mealPlan).map(([key, meal]) => (
                    <div key={key} className={`p-4 rounded-lg transition-all ${meals[key] ? 'bg-gray-900/80' : 'bg-gray-700'}`}>
                        <div onClick={() => toggleMeal(key)} className="flex items-center justify-between cursor-pointer">
                            <div>
                                <p className={`font-medium capitalize ${meals[key] ? 'text-white' : 'text-gray-200'}`}>{meal.name}</p>
                                <p className="text-sm text-gray-400">{meal.calories} kcal, {meal.protein}g protein</p>
                            </div>
                            {meals[key] ? <CheckCircleIcon className="w-6 h-6 text-green-400" /> : <CircleIcon className="w-6 h-6 text-gray-500" />}
                        </div>
                        <button onClick={() => fetchMealSuggestions(key)} className="mt-3 text-xs w-full text-center py-1.5 px-3 bg-indigo-600/50 hover:bg-indigo-600/80 rounded-md font-semibold flex items-center justify-center gap-1.5 transition-colors">
                            <SparklesIcon className="w-4 h-4" /> Suggest Alternatives
                        </button>
                    </div>
                ))}
                </div>
            </Card>
            
            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Hydration</h2>
                <div className="flex items-center justify-center space-x-6">
                    <button onClick={() => handleWater(-1)} className="p-3 bg-gray-700 rounded-full hover:bg-gray-600 transition-colors"><MinusIcon className="w-6 h-6 text-white" /></button>
                    <p className="text-2xl font-bold text-white">{water} <span className="text-lg text-cyan-400">glasses</span></p>
                    <button onClick={() => handleWater(1)} className="p-3 bg-gray-700 rounded-full hover:bg-gray-600 transition-colors"><PlusIcon className="w-6 h-6 text-white" /></button>
                </div>
                <p className="text-xs text-gray-500 mt-3 text-center">Aim for 8-10 glasses (2.5L) per day.</p>
            </Card>
            
            {showSuggestionsModal && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                    <Card className="w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-semibold text-white capitalize">✨ {suggestionMealType} Suggestions</h2>
                            <button onClick={() => setShowSuggestionsModal(false)}><XIcon className="w-6 h-6 text-gray-400 hover:text-white"/></button>
                        </div>
                        {isLoadingSuggestions && <p className="text-center text-gray-400">✨ Generating ideas...</p>}
                        {error && <p className="text-red-400 text-sm text-center">{error}</p>}
                        {!isLoadingSuggestions && suggestions.length > 0 && (
                            <div className="space-y-4">
                                {suggestions.map((s, i) => (
                                    <div key={i} className="bg-gray-700/50 p-4 rounded-lg">
                                        <h3 className="font-semibold text-white">{s.mealName}</h3>
                                        <p className="text-sm text-gray-300 mt-1">{s.description}</p>
                                        <p className="text-xs text-orange-400 mt-2">~{s.calories} kcal, ~{s.protein}g protein</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </Card>
                </div>
            )}
        </div>
    );
};


const CalmScreen = ({ onComplete, calmCompleted }) => {
    const DURATION = 15 * 60; // 15 minutes
    const [time, setTime] = useState(DURATION);
    const [isActive, setIsActive] = useState(false);

    useEffect(() => {
        let interval = null;
        if (isActive && time > 0) {
            interval = setInterval(() => {
                setTime(time => time - 1);
            }, 1000);
        } else if (time === 0) {
            setIsActive(false);
        }
        return () => clearInterval(interval);
    }, [isActive, time]);
    
    const toggleTimer = () => setIsActive(!isActive);

    const minutes = Math.floor(time / 60);
    const seconds = time % 60;
    
    return (
        <div className="space-y-6">
            <Card>
                <h1 className="text-2xl font-bold text-white">Daily Calmness Routine</h1>
                <p className="text-gray-400">15 minutes to manage anxiety and recover.</p>
            </Card>

            <Card className="text-center">
                 <h2 className="text-lg font-semibold text-white mb-4">Meditation Timer</h2>
                 <p className="font-mono text-6xl text-white my-4">{`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`}</p>
                 <button onClick={toggleTimer} className="px-6 py-3 bg-gray-700 rounded-lg text-white font-semibold flex items-center justify-center mx-auto gap-2 hover:bg-gray-600 transition-colors">
                    {isActive ? <><PauseIcon className="w-5 h-5"/> Pause</> : <><PlayIcon className="w-5 h-5"/> Start</>}
                 </button>
            </Card>
            
            <Card>
                <h2 className="text-lg font-semibold text-white mb-2">Box Breathing Technique</h2>
                <div className="space-y-2 text-gray-300">
                    <p>1. <span className="font-semibold">Inhale</span> through your nose for a count of 4.</p>
                    <p>2. <span className="font-semibold">Hold</span> your breath for a count of 4.</p>
                    <p>3. <span className="font-semibold">Exhale</span> through your mouth for a count of 4.</p>
                    <p>4. <span className="font-semibold">Hold</span> at the bottom for a count of 4.</p>
                    <p>5. Repeat for the duration of the session.</p>
                </div>
            </Card>
            
            <button
                onClick={onComplete}
                disabled={calmCompleted}
                className={`w-full p-4 rounded-lg font-bold text-white transition-all flex items-center justify-center gap-2 ${calmCompleted ? 'bg-green-500 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'}`}
            >
                 {calmCompleted ? <><CheckCircleIcon className="w-6 h-6" /> Session Logged!</> : 'Log Calm Session'}
            </button>
        </div>
    );
};

const SettingsScreen = ({ profile, setProfile, nutritionTargets, setNutritionTargets, mealPlan, setMealPlan }) => {
    const [editableProfile, setEditableProfile] = useState(profile);
    const [editableTargets, setEditableTargets] = useState(nutritionTargets);
    const [editableMealPlan, setEditableMealPlan] = useState(mealPlan);
    const [saved, setSaved] = useState(false);

    const handleProfileChange = (e) => {
        const { name, value } = e.target;
        setEditableProfile(prev => ({ ...prev, [name]: value }));
    };

    const handleTargetChange = (e) => {
        const { name, value } = e.target;
        setEditableTargets(prev => ({ ...prev, [name]: parseInt(value, 10) || 0 }));
    };

    const handleMealChange = (mealKey, field, value) => {
        setEditableMealPlan(prev => ({
            ...prev,
            [mealKey]: { ...prev[mealKey], [field]: value }
        }));
    };
    
    const addNewMeal = () => {
        const newMealKey = `newMeal${Date.now()}`;
        setEditableMealPlan(prev => ({
            ...prev,
            [newMealKey]: { name: "New Meal", calories: 0, protein: 0 }
        }));
    };

    const handleSave = () => {
        const initialWeight = profile.initialWeight || editableProfile.currentWeight;
        
        setProfile({ ...editableProfile, initialWeight });
        setNutritionTargets(editableTargets);
        setMealPlan(editableMealPlan);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
    };

    return (
        <div className="space-y-6">
            <Card>
                <h1 className="text-2xl font-bold text-white">Settings</h1>
                <p className="text-gray-400">Customize your profile, goals, and meals.</p>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">My Profile</h2>
                <div className="space-y-4">
                    <div>
                        <label className="text-sm font-medium text-gray-300">Name</label>
                        <input type="text" name="name" value={editableProfile.name} onChange={handleProfileChange} className="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-sm font-medium text-gray-300">Current Weight (kg)</label>
                            <input type="number" name="currentWeight" value={editableProfile.currentWeight} onChange={handleProfileChange} className="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" />
                        </div>
                        <div>
                            <label className="text-sm font-medium text-gray-300">Target Weight (kg)</label>
                            <input type="number" name="targetWeight" value={editableProfile.targetWeight} onChange={handleProfileChange} className="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" />
                        </div>
                    </div>
                </div>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Daily Nutrition Goals</h2>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="text-sm font-medium text-gray-300">Target Calories (kcal)</label>
                        <input type="number" name="calories" value={editableTargets.calories} onChange={handleTargetChange} className="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" />
                    </div>
                    <div>
                        <label className="text-sm font-medium text-gray-300">Target Protein (g)</label>
                        <input type="number" name="protein" value={editableTargets.protein} onChange={handleTargetChange} className="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" />
                    </div>
                </div>
            </Card>

            <Card>
                <h2 className="text-lg font-semibold text-white mb-4">Meal Plan Customization</h2>
                <div className="space-y-4">
                    {Object.entries(editableMealPlan).map(([key, meal]) => (
                        <div key={key} className="p-3 bg-gray-700/50 rounded-lg">
                            <input 
                                type="text"
                                value={meal.name}
                                onChange={(e) => handleMealChange(key, 'name', e.target.value)}
                                className="w-full mb-2 p-2 bg-gray-600 rounded-md font-semibold capitalize border border-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none"
                            />
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="text-xs text-gray-400">Calories</label>
                                    <input type="number" value={meal.calories} onChange={(e) => handleMealChange(key, 'calories', parseInt(e.target.value) || 0)} className="w-full mt-1 p-2 text-sm bg-gray-600 rounded-md border border-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" />
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400">Protein</label>
                                    <input type="number" value={meal.protein} onChange={(e) => handleMealChange(key, 'protein', parseInt(e.target.value) || 0)} className="w-full mt-1 p-2 text-sm bg-gray-600 rounded-md border border-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                <button onClick={addNewMeal} className="w-full mt-4 p-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-semibold flex items-center justify-center gap-2 transition-colors">
                    <PlusIcon className="w-5 h-5"/> Add New Meal
                </button>
            </Card>

            <button onClick={handleSave} className={`w-full p-4 rounded-lg font-bold text-white transition-all flex items-center justify-center gap-2 ${saved ? 'bg-green-500' : 'bg-cyan-600 hover:bg-cyan-700'}`}>
                {saved ? <><CheckCircleIcon className="w-6 h-6"/> Saved!</> : 'Save Changes'}
            </button>
        </div>
    );
};


// --- Main App Component ---

function App() {
    const [view, setView] = useState('dashboard');
    const [profile, setProfile] = useStickyState(DEFAULT_USER_PROFILE, 'health-app-profile');
    const [nutritionTargets, setNutritionTargets] = useStickyState(DEFAULT_NUTRITION_TARGETS, 'health-app-nutrition-targets');
    const [mealPlan, setMealPlan] = useStickyState(DEFAULT_MEAL_PLAN, 'health-app-meal-plan');
    
    // NOTE: Leave apiKey as an empty string. The execution environment will handle it.
    const apiKey = ""; 

    const getTodayKey = () => new Date().toISOString().split('T')[0];
    
    const [dailyLogs, setDailyLogs] = useStickyState({}, 'health-app-logs');
    
    const todayLog = dailyLogs[getTodayKey()] || {
        workoutCompleted: false,
        calmCompleted: false,
        calories: 0,
        protein: 0,
        water: 0,
        meals: {}
    };

    const updateTodayLog = (newLogData) => {
        setDailyLogs(prev => ({
            ...prev,
            [getTodayKey()]: { ...todayLog, ...newLogData }
        }));
    };
    
    const setTodayLogDirectly = (updater) => {
        setDailyLogs(prevDailyLogs => {
            const currentLogForToday = prevDailyLogs[getTodayKey()] || {
                workoutCompleted: false,
                calmCompleted: false,
                calories: 0,
                protein: 0,
                water: 0,
                meals: {}
            };
            const newLog = typeof updater === 'function' ? updater(currentLogForToday) : updater;
            return { ...prevDailyLogs, [getTodayKey()]: newLog };
        });
    }
    
    const handleCompleteWorkout = () => updateTodayLog({ workoutCompleted: true });
    const handleCompleteCalm = () => updateTodayLog({ calmCompleted: true });
    
    const today = new Date().toLocaleString('en-us', { weekday: 'long' });
    const todayWorkoutPlan = WORKOUT_PLAN.find(p => p.day === today);

    const NavItem = ({ icon: Icon, label, viewName }) => (
        <button
            onClick={() => setView(viewName)}
            className={`flex flex-col items-center justify-center w-full p-2 rounded-lg transition-colors ${view === viewName ? 'bg-gray-700 text-cyan-400' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}
        >
            <Icon className="w-6 h-6 mb-1" />
            <span className="text-xs font-medium">{label}</span>
        </button>
    );

    const renderView = () => {
        switch (view) {
            case 'workout':
                return <WorkoutScreen plan={todayWorkoutPlan} onCompleteWorkout={handleCompleteWorkout} workoutCompleted={todayLog.workoutCompleted} apiKey={apiKey} />;
            case 'nutrition':
                return <NutritionScreen todayLog={todayLog} setTodayLog={setTodayLogDirectly} nutritionTargets={nutritionTargets} mealPlan={mealPlan} apiKey={apiKey} />;
            case 'calm':
                return <CalmScreen onComplete={handleCompleteCalm} calmCompleted={todayLog.calmCompleted}/>;
            case 'settings':
                return <SettingsScreen profile={profile} setProfile={setProfile} nutritionTargets={nutritionTargets} setNutritionTargets={setNutritionTargets} mealPlan={mealPlan} setMealPlan={setMealPlan} />;
            case 'dashboard':
            default:
                return <Dashboard profile={profile} nutritionTargets={nutritionTargets} todayLog={todayLog} onNavigate={setView} />;
        }
    };

    return (
        <div className="bg-gray-900 text-white min-h-screen font-sans">
            <div className="max-w-2xl mx-auto pb-24 px-4 pt-6 md:pt-8">
                <main>{renderView()}</main>
            </div>
            
            <nav className="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-sm border-t border-gray-700 z-10">
                <div className="max-w-2xl mx-auto grid grid-cols-5 gap-1 p-1">
                    <NavItem icon={HomeIcon} label="Home" viewName="dashboard" />
                    <NavItem icon={DumbbellIcon} label="Workout" viewName="workout" />
                    <NavItem icon={FlameIcon} label="Nutrition" viewName="nutrition" />
                    <NavItem icon={BrainIcon} label="Calm" viewName="calm" />
                    <NavItem icon={SettingsIcon} label="Settings" viewName="settings" />
                </div>
            </nav>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>

